---
# Argo CD Application: Keycloak with SAML support for SonarQube
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://charts.bitnami.com/bitnami
    chart: keycloak
    targetRevision: 24.7.4
    helm:
      values: |
        tls:
          enabled: true
          autoGenerated: true
        auth:
          adminUser: admin
          adminPassword: Keycloak123!

        ingress:
          enabled: false

        production: true

        proxy: edge

        postgresql:
          enabled: true
          auth:
            postgresPassword: Keycloak123!
            password: Keycloak123!

        persistence:
          enabled: true
          size: 8Gi

        service:
          ports:
            http: 8080
            https: 8443

        extraEnvVars:
          - name: KC_HTTP_ENABLED
            value: "true"
          - name: KC_HTTP_PORT
            value: "8080"
          - name: KC_HOSTNAME
            value: keycloak.maelkloud.com
          - name: KC_PROXY
            value: edge
          - name: KEYCLOAK_LOGLEVEL
            value: DEBUG
          - name: KC_SPI_SAML_ASSERTION_LOGGER
            value: default
          - name: KC_SPI_LOGIN_PROTOCOL_SAML_LOGGER_LEVEL
            value: DEBUG
          - name: KEYCLOAK_DATABASE_CONNECTION_RETRY_ATTEMPTS
            value: "20"
          - name: KEYCLOAK_DATABASE_CONNECTION_RETRY_DELAY
            value: "5"
          - name: KC_HOSTNAME_STRICT
            value: "false"

  destination:
    server: https://kubernetes.default.svc
    namespace: keycloak
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
