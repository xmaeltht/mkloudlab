# Flux HelmRelease for Keycloak (Codecentric Keycloak Helm Chart)
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: codecentric
  namespace: flux-system
spec:
  interval: 1h
  url: https://codecentric.github.io/helm-charts
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: keycloak
  namespace: flux-system
spec:
  interval: 5m
  chart:
    spec:
      chart: keycloak
      version: 18.10.0
      sourceRef:
        kind: HelmRepository
        name: codecentric
        namespace: flux-system
      interval: 1h
  values:
    # Image configuration
    image:
      repository: quay.io/keycloak/keycloak
      tag: "26.4.5"
      pullPolicy: IfNotPresent

    # Replica count
    replicas: 1

    # Keycloak Configuration - explicitly set extraEnv to empty string to avoid schema issues
    extraEnv: ""

    # Using args for Keycloak configuration
    command:
      - "/opt/keycloak/bin/kc.sh"
    args:
      - "start"
      - "--http-enabled=true"
      - "--hostname-strict=false"
      - "--db=postgres"
      - "--db-url-host=postgresql"
      - "--db-url-database=keycloak"
      - "--db-username=keycloak"
      - "--db-password=Keycloak123!"

    # Service configuration
    service:
      type: ClusterIP

    # Ingress disabled - using Gateway API
    ingress:
      enabled: false

    # Security Context
    podSecurityContext:
      fsGroup: 1001
    securityContext:
      runAsUser: 1001
      runAsNonRoot: true
  targetNamespace: keycloak
  install:
    createNamespace: true
