# Flux HelmRelease for Grafana
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana
  namespace: observability
spec:
  interval: 5m
  chart:
    spec:
      chart: grafana
      version: 10.4.1
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 1h
  values:
    persistence:
      enabled: true
      storageClassName: local-path
      size: 2Gi

    # Disable init container - newer Grafana versions handle permissions internally
    initChownData:
      enabled: false

    adminPassword: admin

    # Install required plugins explicitly
    plugins:
      - grafana-piechart-panel
      - grafana-clock-panel

    # Configure Grafana to work behind reverse proxy
    grafana.ini:
      server:
        domain: grafana.maelkloud.com
        root_url: https://grafana.maelkloud.com
        serve_from_sub_path: false
        enable_gzip: true
        protocol: http
        http_addr: 0.0.0.0
        http_port: 3000
        enforce_domain: false
      # Security headers for proxy
      security:
        cookie_secure: false
        cookie_samesite: lax
        allow_embedding: true
        csrf_trusted_origins: https://grafana.maelkloud.com
        csrf_additional_headers: X-Forwarded-For
      # Logging for debugging
      log:
        mode: console
        level: info
      auth.anonymous:
        enabled: false
      # Datasource proxy settings
      datasources:
        timeout: 60
        max_idle_conns: 100
        max_idle_conns_per_host: 10

    # Environment variables for proper reverse proxy operation
    env:
      GF_SERVER_ROOT_URL: https://grafana.maelkloud.com
      GF_SERVER_DOMAIN: grafana.maelkloud.com
      GF_SERVER_ENFORCE_DOMAIN: "false"
      GF_SECURITY_COOKIE_SECURE: "false"
      GF_SECURITY_COOKIE_SAMESITE: "lax"

    service:
      type: ClusterIP
      port: 80
      targetPort: 3000

    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://prometheus-kube-prometheus-prometheus.observability.svc.cluster.local:9090
            access: proxy
            isDefault: true
            uid: prometheus
            jsonData:
              httpMethod: POST
              timeInterval: 15s
          - name: Loki
            type: loki
            url: http://loki.observability.svc.cluster.local:3100
            access: proxy
            uid: loki
            jsonData:
              maxLines: 1000
          - name: Tempo
            type: tempo
            url: http://tempo.observability.svc.cluster.local:3200
            access: proxy
            uid: tempo
            jsonData:
              httpMethod: GET
              tracesToLogs:
                datasourceUid: loki
                tags: ['job', 'instance', 'pod', 'namespace']
                mappedTags: [{ key: 'service.name', value: 'service' }]
                mapTagNamesEnabled: false
                spanStartTimeShift: '1h'
                spanEndTimeShift: '1h'
                filterByTraceID: false
                filterBySpanID: false
              tracesToMetrics:
                datasourceUid: prometheus
              serviceMap:
                datasourceUid: prometheus
              nodeGraph:
                enabled: true
              search:
                hide: false
              lokiSearch:
                datasourceUid: loki
