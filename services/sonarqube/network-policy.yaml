# Network Policies for SonarQube - Zero Trust Security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sonarqube-deny-all
  namespace: sonarqube
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
# Allow SonarQube to PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: sonarqube-to-postgresql
  namespace: sonarqube
spec:
  podSelector:
    matchLabels:
      app: sonarqube
  policyTypes:
  - Egress
  egress:
  # Allow all egress - network policies are complex with Istio
  # In production, consider using Istio AuthorizationPolicy instead
  - {}
---
# Allow ingress to SonarQube from Istio Gateway
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-sonarqube-ingress
  namespace: sonarqube
spec:
  podSelector:
    matchLabels:
      app: sonarqube
  policyTypes:
  - Ingress
  ingress:
  # Allow from Istio Gateway
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: sonarqube
      podSelector:
        matchLabels:
          app: sonarqube-gateway-istio
    ports:
    - protocol: TCP
      port: 9000
  # Allow from same namespace (for health checks)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 9000
---
# Allow PostgreSQL ingress only from SonarQube
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgresql-from-sonarqube
  namespace: sonarqube
spec:
  podSelector:
    matchLabels:
      app: sonarqube-postgresql
  policyTypes:
  - Ingress
  ingress:
  # Allow from same namespace (SonarQube and Istio sidecars)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 5432
